{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>Configure Your Ship <span class="pill">Game {{ game.code }}</span></h2>
  <p class="muted">Budget: 100 tokens. Choose a ship and optional upgrades. Server validates costs.</p>

  <form method="post" action="/configure" id="config-form">
    <input type="hidden" name="code" value="{{ game.code }}">
    <input type="hidden" name="player_id" value="{{ player.id }}">
    <input type="hidden" id="ship_type_id" name="ship_type_id" value="">

    <div class="mb-3">
      <label class="block text-sm font-medium text-stone-700">Choose your ship</label>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
        {% for s in ship_cards %}
        <div>
          <div class="card ship-card h-full {% if not s.id %}opacity-50{% endif %}" {% if s.id %}tabindex="0" role="button" aria-pressed="false"{% endif %} data-id="{{ s.id }}" data-cost="{{ s.cost }}">
            <img src="{{ s.image_url }}" alt="{{ s.name }}" class="w-full rounded-t-md">
            <div class="mt-2">
              <div class="flex items-center justify-between">
                <span class="font-semibold">{{ s.name }}</span>
                {% if s.id %}
                <span class="pill">{{ s.cost }} tokens</span>
                {% else %}
                <span class="pill" style="background:#fbbf24; color:#111827;">Unavailable</span>
                {% endif %}
              </div>
              <div class="text-sm muted mt-1">
                <div>Weight: {{ s.weight }} | Crew: {{ s.crew }}</div>
                <div>Hull/Shields/Power: {{ s.hull_strength }}/{{ s.shields }}/{{ s.power_capacity }}</div>
                <div>Space/Capacity: {{ s.space_capacity }}/{{ s.weight_capacity }}</div>
                <div>Weapons:</div>
                <ul class="list-none m-0 p-0">
                  <li>Lasers: {{ s.lasers }}</li>
                  <li>Railguns: {{ s.railguns }}</li>
                  <li>Missiles: {{ s.missiles }}</li>
                  <li>Nuclear Weapons: {{ s.nuclear_weapons }}</li>
                  <li>EMP: {{ s.emp }}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="mb-3">
      <label class="block text-sm font-medium text-stone-700">Upgrades</label>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
        {% for u in upgrades %}
        <label class="flex items-center gap-2">
          <input class="h-4 w-4 rounded border-stone-500/70 bg-stone-200/60" type="checkbox" id="u{{ u.id }}" name="upgrade_ids" value="{{ u.id }}" data-cost="{{ u.cost }}">
          <span>{{ u.name }} <span class="muted">({{ u.cost }})</span></span>
        </label>
        {% endfor %}
      </div>
    </div>

    <div class="mt-3 flex flex-wrap items-center gap-3">
      <div class="pill">Estimated cost: <span id="est">0</span> / 100</div>
      <!-- Over-budget warning banner: placed just above the submit button -->
      <div id="over-budget" class="warning-banner" role="alert" aria-live="assertive" style="display:none;">
        YOU HAVE SPENT TOO MUCH
      </div>
      <button type="submit" class="primary">Save &amp; Go to Lobby</button>
      <a class="pill" href="/join/{{ game.code }}">Invite link or code: {{ game.code }}</a>
    </div>
  </form>
</div>
<script>
(function() {
  const BUDGET = 100;
  const banner = document.getElementById('over-budget');
  const estEl = document.getElementById('est');
  const hiddenId = document.getElementById('ship_type_id');

  let selectedCost = 0;

  function setSelectedCard(card){
    document.querySelectorAll('.ship-card').forEach(c => c.classList.remove('ring-2', 'ring-amber-600', 'shadow-lg'));
    if (card) {
      card.classList.add('ring-2', 'ring-amber-600', 'shadow-lg');
      hiddenId.value = card.dataset.id || '';
      selectedCost = parseInt(card.dataset.cost || '0');
    } else {
      hiddenId.value = '';
      selectedCost = 0;
    }
    recalc();
  }

  function recalc(){
    let upCost = 0;
    document.querySelectorAll('input[name="upgrade_ids"]:checked').forEach(cb => { upCost += parseInt(cb.dataset.cost || '0'); });
    const total = selectedCost + upCost;
    estEl.textContent = total;
    if (total > BUDGET) {
      banner.style.display = 'block';
      banner.classList.add('flash');
    } else {
      banner.style.display = 'none';
      banner.classList.remove('flash');
    }
  }

  document.querySelectorAll('.ship-card').forEach(card => {
    if (card.dataset.id) {
      card.addEventListener('click', () => setSelectedCard(card));
      card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setSelectedCard(card); } });
    }
  });

  document.querySelectorAll('input[name="upgrade_ids"]').forEach(cb => cb.addEventListener('change', recalc));
  recalc();
})();
</script>
{% endblock %}
