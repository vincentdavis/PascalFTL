{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col">
    <div class="card">
      <h2>Game <span class="pill">{{ game.code }}</span></h2>
      <div id="players"
           hx-get="/fragment/game_players?code={{ game.code }}"
           hx-trigger="load"
           hx-swap="outerHTML">
        <!-- players fragment will load here -->
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card">
      <h3>Battle Log</h3>
      <div id="log" class="log"></div>
      <div id="status" class="muted" style="margin-top:8px;">Connecting...</div>
      <div id="actions"
           hx-get="/fragment/game_actions?code={{ game.code }}{% if player_id %}&player_id={{ player_id }}{% endif %}"
           hx-trigger="load"
           hx-swap="outerHTML"></div>
      <div style="margin-top:8px;">
        <a class="pill" href="/game_over/{{ game.code }}">Go to Game Over</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
(function(){
  const code = "{{ game.code }}";
  const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
  const ws = new WebSocket(`${proto}://${location.host}/ws/${code}`);
  const log = document.getElementById('log');
  const status = document.getElementById('status');
  function append(text){ log.textContent += text; log.scrollTop = log.scrollHeight; }
  ws.onopen = () => { status.textContent = 'Connected'; };
  ws.onmessage = (ev) => {
    if (ev.data === '__END__') {
      status.textContent = 'Battle complete';
      setTimeout(() => { window.location.href = `/game_over/${code}`; }, 800);
      return;
    }
    append(ev.data);
    // After any broadcast, refresh the action controls fragment to reflect turn/state
    const actions = document.getElementById('actions');
    if (actions) {
      htmx.ajax('GET', `/fragment/game_actions?code=${code}{% if player_id %}&player_id={{ player_id }}{% endif %}`, {target: '#actions', swap: 'outerHTML'});
    }
    const players = document.getElementById('players');
    if (players) {
      htmx.ajax('GET', `/fragment/game_players?code=${code}`, {target: '#players', swap: 'outerHTML'});
    }
  };
  ws.onclose = () => { status.textContent = 'Disconnected'; };
})();
</script>
{% endblock %}
